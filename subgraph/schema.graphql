# AGI Alpha Node KPI Subgraph schema
#
# Four event families (`AlphaWUMinted`, `AlphaWUValidated`, `AlphaWUAccepted`,
# and `SlashApplied`) fully determine the acceptance, quality, latency, and
# yield KPIs. This schema projects those logs into deterministic entities so
# roll-ups, dashboards, and operators can recompute α‑WU performance without
# bespoke ETL pipelines.

"""Enumerates which principal owns a histogram bucket (agent, node, validator)."""
enum HistogramOwner {
  AGENT
  NODE
  VALIDATOR
}

"""Aggregated alpha work unit statistics for an agent identity powering AR/VQS/OTC/SAY windows."""
type Agent @entity(immutable: false) {
  id: ID!
  totalWorkUnits: BigInt!
  totalAccepted: BigInt!
  totalValidations: BigInt!
  totalSlashAmount: BigInt!
  totalStake: BigInt!
  lastUpdated: Int!
  workUnits: [WorkUnit!]! @derivedFrom(field: "agent")
  dailyMetrics: [AgentDailyMetric!]! @derivedFrom(field: "agent")
  metricWindows: [AgentMetricWindow!]! @derivedFrom(field: "agent")
}

"""Aggregated alpha work unit statistics for a node identity powering AR/VQS/OTC/SAY windows."""
type Node @entity(immutable: false) {
  id: ID!
  totalWorkUnits: BigInt!
  totalAccepted: BigInt!
  totalValidations: BigInt!
  totalSlashAmount: BigInt!
  totalStake: BigInt!
  lastUpdated: Int!
  workUnits: [WorkUnit!]! @derivedFrom(field: "node")
  dailyMetrics: [NodeDailyMetric!]! @derivedFrom(field: "node")
  metricWindows: [NodeMetricWindow!]! @derivedFrom(field: "node")
}

"""Validator level counters with stake, quality, and slashing totals backing AR/VQS/OTC/SAY rollups."""
type Validator @entity(immutable: false) {
  id: ID!
  totalWorkUnits: BigInt!
  totalAccepted: BigInt!
  totalValidations: BigInt!
  totalSlashAmount: BigInt!
  totalStake: BigInt!
  lastUpdated: Int!
  participations: [ValidatorParticipation!]! @derivedFrom(field: "validator")
  dailyMetrics: [ValidatorDailyMetric!]! @derivedFrom(field: "validator")
  metricWindows: [ValidatorMetricWindow!]! @derivedFrom(field: "validator")
}

"""Represents a single minted alpha work unit and its validation state (input for AR, OTC, and SAY)."""
type WorkUnit @entity(immutable: false) {
  id: ID!
  agent: Agent!
  node: Node!
  mintedAt: Int!
  acceptedAt: Int
  lastValidatedAt: Int
  validationCount: BigInt!
  totalScore: BigInt!
  totalStake: BigInt!
  totalSlashAmount: BigInt!
  validatorIds: [String!]!
  participations: [ValidatorParticipation!]! @derivedFrom(field: "workUnit")
}

"""Join entity linking validators to the work units they reviewed (source for VQS weighting)."""
type ValidatorParticipation @entity(immutable: false) {
  id: ID!
  workUnit: WorkUnit!
  validator: Validator!
  stake: BigInt!
  score: BigInt!
  lastValidatedAt: Int!
}

"""Daily agent-level totals used for recomputing AR/VQS/OTC/SAY rolling windows."""
type AgentDailyMetric @entity(immutable: false) {
  id: ID!
  agent: Agent!
  day: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  scoreSum: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
}

"""Daily node-level totals used for recomputing AR/VQS/OTC/SAY rolling windows."""
type NodeDailyMetric @entity(immutable: false) {
  id: ID!
  node: Node!
  day: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  scoreSum: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
}

"""Daily validator-level totals used for recomputing AR/VQS/OTC/SAY rolling windows."""
type ValidatorDailyMetric @entity(immutable: false) {
  id: ID!
  validator: Validator!
  day: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  scoreSum: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
}

"""Rolling KPI snapshot for an agent (e.g. 7-day or 30-day window) covering AR, VQS, OTC, and SAY."""
type AgentMetricWindow @entity(immutable: false) {
  id: ID!
  agent: Agent!
  windowDays: Int!
  windowStart: Int!
  windowEnd: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
  acceptanceRate: BigDecimal!
  validatorWeightedQuality: BigDecimal!
  onTimeP95Seconds: Int!
  slashingAdjustedYield: BigDecimal!
  updatedAt: Int!
}

"""Rolling KPI snapshot for a node (e.g. 7-day or 30-day window) covering AR, VQS, OTC, and SAY."""
type NodeMetricWindow @entity(immutable: false) {
  id: ID!
  node: Node!
  windowDays: Int!
  windowStart: Int!
  windowEnd: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
  acceptanceRate: BigDecimal!
  validatorWeightedQuality: BigDecimal!
  onTimeP95Seconds: Int!
  slashingAdjustedYield: BigDecimal!
  updatedAt: Int!
}

"""Rolling KPI snapshot for a validator (e.g. 7-day or 30-day window) covering AR, VQS, OTC, and SAY."""
type ValidatorMetricWindow @entity(immutable: false) {
  id: ID!
  validator: Validator!
  windowDays: Int!
  windowStart: Int!
  windowEnd: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
  acceptanceRate: BigDecimal!
  validatorWeightedQuality: BigDecimal!
  onTimeP95Seconds: Int!
  slashingAdjustedYield: BigDecimal!
  updatedAt: Int!
}

"""Stake-weighted quality histogram bucket for KPI median calculations (feeds VQS)."""
type QualityBucket @entity(immutable: false) {
  id: ID!
  ownerType: HistogramOwner!
  owner: String!
  day: Int!
  bucket: Int!
  stake: BigInt!
}

"""Latency histogram bucket supporting p95 cycle-time computation (feeds OTC)."""
type LatencyBucket @entity(immutable: false) {
  id: ID!
  ownerType: HistogramOwner!
  owner: String!
  day: Int!
  bucket: Int!
  count: BigInt!
}

"""Immutable record of every SlashApplied event for downstream analytics and dashboards."""
type SlashEvent @entity(immutable: true) {
  id: ID!
  workUnit: WorkUnit!
  validator: Validator!
  amount: BigInt!
  slashedAt: Int!
}
