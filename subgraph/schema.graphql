# AGI Alpha Node KPI Subgraph schema

"""Enumerates which principal owns a histogram bucket (agent, node, validator)."""
enum HistogramOwner {
  AGENT
  NODE
  VALIDATOR
}

"""Aggregated alpha work unit statistics for an agent identity."""
type Agent @entity(immutable: false) {
  id: ID!
  totalWorkUnits: BigInt!
  totalAccepted: BigInt!
  totalValidations: BigInt!
  totalSlashAmount: BigInt!
  totalStake: BigInt!
  lastUpdated: Int!
  workUnits: [WorkUnit!]! @derivedFrom(field: "agent")
  dailyMetrics: [AgentDailyMetric!]! @derivedFrom(field: "agent")
  metricWindows: [AgentMetricWindow!]! @derivedFrom(field: "agent")
}

"""Aggregated alpha work unit statistics for a node identity."""
type Node @entity(immutable: false) {
  id: ID!
  totalWorkUnits: BigInt!
  totalAccepted: BigInt!
  totalValidations: BigInt!
  totalSlashAmount: BigInt!
  totalStake: BigInt!
  lastUpdated: Int!
  workUnits: [WorkUnit!]! @derivedFrom(field: "node")
  dailyMetrics: [NodeDailyMetric!]! @derivedFrom(field: "node")
  metricWindows: [NodeMetricWindow!]! @derivedFrom(field: "node")
}

"""Validator level counters with stake, quality, and slashing totals."""
type Validator @entity(immutable: false) {
  id: ID!
  totalWorkUnits: BigInt!
  totalAccepted: BigInt!
  totalValidations: BigInt!
  totalSlashAmount: BigInt!
  totalStake: BigInt!
  lastUpdated: Int!
  participations: [ValidatorParticipation!]! @derivedFrom(field: "validator")
  dailyMetrics: [ValidatorDailyMetric!]! @derivedFrom(field: "validator")
  metricWindows: [ValidatorMetricWindow!]! @derivedFrom(field: "validator")
}

"""Represents a single minted alpha work unit and its validation state."""
type WorkUnit @entity(immutable: false) {
  id: ID!
  agent: Agent!
  node: Node!
  mintedAt: Int!
  acceptedAt: Int
  lastValidatedAt: Int
  validationCount: BigInt!
  totalScore: BigInt!
  totalStake: BigInt!
  validatorIds: [String!]!
  participations: [ValidatorParticipation!]! @derivedFrom(field: "workUnit")
}

"""Join entity linking validators to the work units they reviewed."""
type ValidatorParticipation @entity(immutable: false) {
  id: ID!
  workUnit: WorkUnit!
  validator: Validator!
  stake: BigInt!
  score: BigInt!
  lastValidatedAt: Int!
}

"""Daily agent-level totals used for recomputing rolling KPI windows."""
type AgentDailyMetric @entity(immutable: false) {
  id: ID!
  agent: Agent!
  day: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  scoreSum: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
}

"""Daily node-level totals used for recomputing rolling KPI windows."""
type NodeDailyMetric @entity(immutable: false) {
  id: ID!
  node: Node!
  day: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  scoreSum: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
}

"""Daily validator-level totals used for recomputing rolling KPI windows."""
type ValidatorDailyMetric @entity(immutable: false) {
  id: ID!
  validator: Validator!
  day: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  scoreSum: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
}

"""Rolling KPI snapshot for an agent (e.g. 7-day or 30-day window)."""
type AgentMetricWindow @entity(immutable: false) {
  id: ID!
  agent: Agent!
  windowDays: Int!
  windowStart: Int!
  windowEnd: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
  acceptanceRate: BigDecimal!
  validatorWeightedQuality: BigDecimal!
  onTimeP95Seconds: Int!
  slashingAdjustedYield: BigDecimal!
  updatedAt: Int!
}

"""Rolling KPI snapshot for a node (e.g. 7-day or 30-day window)."""
type NodeMetricWindow @entity(immutable: false) {
  id: ID!
  node: Node!
  windowDays: Int!
  windowStart: Int!
  windowEnd: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
  acceptanceRate: BigDecimal!
  validatorWeightedQuality: BigDecimal!
  onTimeP95Seconds: Int!
  slashingAdjustedYield: BigDecimal!
  updatedAt: Int!
}

"""Rolling KPI snapshot for a validator (e.g. 7-day or 30-day window)."""
type ValidatorMetricWindow @entity(immutable: false) {
  id: ID!
  validator: Validator!
  windowDays: Int!
  windowStart: Int!
  windowEnd: Int!
  mintedCount: BigInt!
  acceptedCount: BigInt!
  validationCount: BigInt!
  stakeSum: BigInt!
  slashAmount: BigInt!
  acceptanceRate: BigDecimal!
  validatorWeightedQuality: BigDecimal!
  onTimeP95Seconds: Int!
  slashingAdjustedYield: BigDecimal!
  updatedAt: Int!
}

"""Stake-weighted quality histogram bucket for KPI median calculations."""
type QualityBucket @entity(immutable: false) {
  id: ID!
  ownerType: HistogramOwner!
  owner: String!
  day: Int!
  bucket: Int!
  stake: BigInt!
}

"""Latency histogram bucket supporting p95 cycle-time computation."""
type LatencyBucket @entity(immutable: false) {
  id: ID!
  ownerType: HistogramOwner!
  owner: String!
  day: Int!
  bucket: Int!
  count: BigInt!
}
